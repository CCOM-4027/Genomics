#!/usr/bin/python
import os, sys, argparse
import parsingfasta as parse
import laad
from laad import do

extensions = ['fasta',',gbk','sam']

parser = argparse.ArgumentParser()
parser.add_argument('-i', '--input')
parser.add_argument('-o', '--output')
parser.add_argument('-of', '--outfile')
parser.add_argument('-q', '--query')
parser.add_argument('-u', '--user', default='laadguest')
parser.add_argument('-v', '--verbose')
args = parser.parse_args()

def file2seqs(filename):
    print "converting file",filename, "to sequence object"
    return parse.file_to_entries(filename)

def make_file(sequences, filename):
    if parse.extension(filename) in extensions:
        print "file", filename, "created with the following sequences"
        for sequence in sequences:
            print "\t", sequence.id
    else:
        print "Error: specified invalid file extension for output"

sequences = []

if args.input:
    if not os.path.exists(args.input): 
        print "File or directory does not exist"
    else:
        def add2sequences(file):
            if parse.extension(file) in extensions:
                print "Converting file", file, "into sequence object"
                sequences.extend(file2seqs(file))

        if os.path.isdir(args.input):
            if args.verbose:
                print "Processing files in directory ", args.input
            for filename in os.listdir(args.input):
                add2sequences(filename)
        else: 
            add2sequences(args.input)

    if args.verbose:
        print "adding sequences to database"
    do(laad.addseqs(sequences), args.user)

if args.query:
    if args.verbose:
        print "Sending query:", args.query
    sequences = laad.query(args.query, args.user)

if args.output:
    print sequences

if args.outfile:
    make_file(sequences, args.output)
